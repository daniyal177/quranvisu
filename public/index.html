<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Quran Viz Shorts</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800;900&family=Noto+Naskh+Arabic:wght@500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#07080b;
      --ink:#f6f7fb;
      --muted:#aab3c2;
      --line:rgba(255,255,255,.10);

      --goldA:#ffe2a6;
      --goldB:#d6b173;
      --goldC:#fff0c9;

      --shadow: 0 18px 70px rgba(0,0,0,.60);

      --arabic: "Noto Naskh Arabic", serif;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;

      --videoBright: 0.55;
      --ui: 1;

      --glass: rgba(0,0,0,.34);
      --glass2: rgba(0,0,0,.48);
      --glass3: rgba(10,12,16,.88);
      --stroke: rgba(255,255,255,.14);

      --good: rgba(110,231,255,.92);
      --warn: rgba(255,95,95,.95);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 65% 0%, #121a2b 0%, var(--bg) 55%);
      color:var(--ink);
      font-family: var(--sans);
      overflow:hidden;
      touch-action: none;
    }

    .app{height:100%; width:100%;}

    /* ---------- Buttons (theme-aligned) ---------- */
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      border-radius: calc(12px * var(--ui));
      padding: calc(10px * var(--ui)) calc(14px * var(--ui));
      font-weight: 900;
      letter-spacing: .2px;
      cursor:pointer;
      user-select:none;
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 50px rgba(0,0,0,.30);
    }
    .btn.big{
      padding: calc(12px * var(--ui)) calc(16px * var(--ui));
      border-radius: calc(14px * var(--ui));
      font-size: calc(14px * var(--ui));
    }
    .btn.primary{
      border-color: rgba(110,231,255,.28);
      background: linear-gradient(135deg, rgba(110,231,255,.22), rgba(201,166,106,.18));
      box-shadow:
        0 14px 55px rgba(0,0,0,.38),
        0 0 0 3px rgba(110,231,255,.10);
    }

    /* ---------- micro-interactions ---------- */
    .btn, .gearBtn, .xBtn, .navCircle, .infoOrb, .card .btn, .infoFull .close, .helpBtn, .wizBtn{
      transform: translateZ(0);
      transition: transform .14s ease, background .14s ease, border-color .14s ease, box-shadow .14s ease, filter .14s ease, opacity .14s ease;
      will-change: transform, filter, opacity;
    }
    .btn:hover, .gearBtn:hover, .xBtn:hover, .infoFull .close:hover, .helpBtn:hover, .wizBtn:hover{
      transform: translateY(-1px);
      filter: brightness(1.02);
      box-shadow: 0 14px 55px rgba(0,0,0,.35);
    }
    .btn:active, .gearBtn:active, .xBtn:active, .infoFull .close:active, .helpBtn:active, .wizBtn:active{
      transform: translateY(0px) scale(.98);
      box-shadow: 0 10px 35px rgba(0,0,0,.25);
    }
    .pop{ animation: pop .18s ease-out; }
    @keyframes pop{ 0%{transform: scale(.98)} 60%{transform: scale(1.06)} 100%{transform: scale(1.00)} }

    /* ---------- Viewer ---------- */
    .viewer{height:100%;width:100%;display:block;position:relative;background:#05060a;}
    .stage{position:absolute;inset:0;display:grid;place-items:center;}
    .frame{
      position:relative;
      width: min(520px, 100vw);
      height: 100%;
      overflow:hidden;
      background:#05060a;
      border-left:1px solid rgba(255,255,255,.06);
      border-right:1px solid rgba(255,255,255,.06);
      touch-action: none;
      -webkit-user-select:none;
      user-select:none;
      -webkit-touch-callout:none;
    }
    @media (min-width: 900px) and (orientation: landscape){
      .stage{place-items:stretch;}
      .frame{width:100vw;height:100vh;border:none;}
    }
    .viewer.immersive .frame{ width:100vw; height:100vh; border:none; border-radius:0; }

    /* Dim system for demo */
    .dimTarget{ transition: filter .15s ease, opacity .15s ease; }
    .frame.demoActive .dimTarget{
      filter: brightness(.22) saturate(.55) contrast(.95);
      opacity: .18;
    }
    .frame.demoActive .dimTarget.noDim{
      filter: none !important;
      opacity: 1 !important;
    }

    .fallbackBg{
      position:absolute; inset:0;
      background:
        radial-gradient(900px 600px at 60% 10%, rgba(255,200,140,.09), rgba(0,0,0,0) 60%),
        radial-gradient(900px 700px at 30% 90%, rgba(110,231,255,.06), rgba(0,0,0,0) 65%),
        linear-gradient(180deg, #05060a, #02030a);
    }
    video.bg{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      transform: scale(1.02);
      filter: brightness(var(--videoBright));
      opacity:.98;
      transition: opacity .15s ease;
      z-index: 1;

      /* Reduce ‚Äúpress & hold‚Äù save prompts as much as possible */
      pointer-events:none;              /* clicks go to frame */
      -webkit-touch-callout:none;
      -webkit-user-select:none;
      user-select:none;
    }
    video.bg.hidden{opacity:0;}

    .vignette{
      position:absolute; inset:0;
      background: radial-gradient(circle at center, rgba(0,0,0,0.0) 0%, rgba(0,0,0,.55) 72%, rgba(0,0,0,.88) 100%);
      pointer-events:none;
      z-index: 2;
    }

    .progress{
      position:absolute;left:0;right:0;top:0;height:calc(3px * var(--ui));
      background:rgba(255,255,255,.08);z-index:10;
    }
    .progress .bar{
      height:100%;width:0%;
      background: linear-gradient(90deg, rgba(110,231,255,.78), rgba(201,166,106,.72));
    }

    .overlayTop{
      position:absolute;left:0;right:0;top:0;
      padding: calc(14px * var(--ui)) calc(12px * var(--ui)) calc(10px * var(--ui));
      display:flex;justify-content:space-between;gap:calc(10px * var(--ui));
      z-index: 20;
      pointer-events:auto;
    }
    .leftTop,.rightTop{display:flex;gap:calc(10px * var(--ui));align-items:center;flex-wrap:wrap}

    .gearBtn, .helpBtn{
      width:calc(42px * var(--ui));
      height:calc(42px * var(--ui));
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: var(--glass2);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      user-select:none;
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 50px rgba(0,0,0,.35);
      display:grid;
      place-items:center;
      font-size: calc(18px * var(--ui));
      line-height: 1;
      position: relative;
      z-index: 1;
    }

    .pausePill{
      position:absolute;left:50%;top:calc(64px * var(--ui));
      transform:translateX(-50%);
      z-index:25;display:none;pointer-events:none;
      padding: calc(8px * var(--ui)) calc(12px * var(--ui));
      border-radius:999px;border:1px solid rgba(255,255,255,.18);
      background: var(--glass2);
      backdrop-filter: blur(10px);
      font-weight:900;
    }

    /* ---------- Text Layers ---------- */
    .textArea{
      position:absolute; inset:0;
      display:flex;align-items:center;justify-content:center;
      padding: calc(28px * var(--ui)) calc(22px * var(--ui)) calc(122px * var(--ui));
      text-align:center;
      pointer-events:none;
      z-index: 6;
      overflow:hidden;
    }
    .layer{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      width:100%;
      display:flex;
      flex-direction:column;
      gap:calc(12px * var(--ui));
      padding: 0 calc(10px * var(--ui));
      will-change: transform, filter, opacity;
    }
    .layer .arabic{
      font-family: var(--arabic);
      direction: rtl;
      font-weight:700;
      background: linear-gradient(110deg, rgba(255,255,255,.95), rgba(210,219,233,.95), rgba(255,255,255,.98));
      background-size: 260% 260%;
      -webkit-background-clip:text;background-clip:text;color:transparent;
      filter: drop-shadow(0 10px 26px rgba(0,0,0,.65));
      opacity:.98;
    }
    .layer .arabic.hidden{display:none;}
    .layer .english{
      font-weight:900;
      background: linear-gradient(110deg, var(--goldA), var(--goldB), var(--goldC));
      background-size: 260% 260%;
      -webkit-background-clip:text;background-clip:text;color:transparent;
      filter: drop-shadow(0 10px 26px rgba(0,0,0,.60));
      white-space: pre-line;
    }

    .in{ animation: textIn .22s ease-out both, textScaleUp 1.35s ease-out forwards; }
    .out{ animation: textOut .22s ease-in both; }
    @keyframes textIn{
      0%{ opacity:0; transform: translate(-50%, calc(-50% + 34px)); filter: blur(6px); }
      100%{ opacity:1; transform: translate(-50%, -50%); filter: blur(0px); }
    }
    @keyframes textOut{
      0%{ opacity:1; transform: translate(-50%,-50%); filter: blur(0px); }
      100%{ opacity:0; transform: translate(-50%, calc(-50% - 34px)); filter: blur(6px); }
    }
    @keyframes textScaleUp{
      0%{ transform: translate(-50%,-50%) scale(.95); }
      100%{ transform: translate(-50%,-50%) scale(1); }
    }
    @media (prefers-reduced-motion: reduce){ .in,.out{animation:none} }

    /* ---------- Bottom nav ---------- */
    .badge{
      position:absolute;left:0;right:0;bottom:calc(24px * var(--ui));
      display:flex;flex-direction:column;align-items:center;gap:calc(10px * var(--ui));
      pointer-events:none;
      z-index: 12;
    }
    .badgeRow{
      width:100%;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      padding-left: calc(18px * var(--ui));
      padding-right: calc(14px * var(--ui));
      align-items:center;
    }
    @media (min-width: 900px) and (orientation: landscape){
      .badge{ bottom: calc(18px * var(--ui)); }
      .badgeRow{
        padding-left: calc(22px * var(--ui));
        padding-right: calc(22px * var(--ui));
      }
    }

    .navBlock{
      pointer-events:auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: calc(8px * var(--ui));
      user-select:none;
    }
    .navCircle{
      width:calc(96px * var(--ui));
      height:calc(96px * var(--ui));
      border-radius:999px;
      border:1px solid rgba(201,166,106,.55);
      background: var(--glass2);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 50px rgba(0,0,0,.45);
      display:grid;
      place-items:center;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      text-align:center;
      z-index: 1;
    }
    .navCircle::before{
      content:"";
      position:absolute; inset:-40%;
      background:
        radial-gradient(circle at 30% 30%, rgba(110,231,255,.18), rgba(0,0,0,0) 55%),
        radial-gradient(circle at 70% 70%, rgba(201,166,106,.16), rgba(0,0,0,0) 55%);
      transform: rotate(12deg);
      opacity:.9;
      pointer-events:none;
    }
    .circleContent{
      position:relative;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: calc(4px * var(--ui));
      line-height:1;
      text-shadow: 0 14px 26px rgba(0,0,0,.55);
    }
    .circleContent .lab{
      font-size: calc(10px * var(--ui));
      letter-spacing: calc(2px * var(--ui));
      font-weight: 900;
      color: rgba(201,166,106,.95);
    }
    .circleContent .num{
      font-weight: 900;
      font-size: calc(28px * var(--ui));
      color: rgba(255,255,255,.95);
      transform: translateY(-1px);
    }
    .surahOutside{
      font-size:calc(10px * var(--ui));
      letter-spacing:calc(2.2px * var(--ui));
      color: rgba(201,166,106,.88);
      text-transform:uppercase;
      line-height:1.05;
      max-width: min(78vw, 420px);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-shadow: 0 12px 26px rgba(0,0,0,.55);
      pointer-events:none;
      margin-top: calc(2px * var(--ui));
    }
    .navCircle.glow{
      border-color: rgba(110,231,255,.55);
      box-shadow:
        0 14px 50px rgba(0,0,0,.45),
        0 0 0 3px rgba(110,231,255,.12),
        0 0 34px rgba(110,231,255,.18);
      animation: circleGlow .22s ease-out;
    }
    @keyframes circleGlow{
      0%{ transform: scale(.98); filter: blur(0px); }
      60%{ transform: scale(1.06); filter: blur(.0px); }
      100%{ transform: scale(1.00); filter: blur(0px); }
    }

    .infoOrb{
      justify-self:end;
      width:calc(58px * var(--ui));height:calc(58px * var(--ui));
      border-radius:999px;
      border:1px solid rgba(255,255,255,.70);
      background: var(--glass2);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;justify-content:center;
      pointer-events:auto;
      cursor:pointer;
      box-shadow: 0 14px 50px rgba(0,0,0,.45);
      user-select:none;
      position: relative;
      z-index: 1;
    }
    .infoOrb .i{font-weight:900;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}

    /* ---------- End overlay ---------- */
    .endOverlay{
      position:absolute; inset:0;
      display:none;
      z-index: 45;
      pointer-events:auto;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      place-items:center;
      padding: calc(24px * var(--ui));
      text-align:center;
    }
    .endCard{
      width:min(420px, 92vw);
      border-radius: calc(22px * var(--ui));
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.30);
      box-shadow: var(--shadow);
      padding: calc(16px * var(--ui)) calc(16px * var(--ui));
    }
    .endCard h3{ margin:0 0 calc(6px * var(--ui)); font-size: calc(18px * var(--ui)); letter-spacing:.2px; }
    .endCard p{ margin:0 0 calc(14px * var(--ui)); color: rgba(219,231,255,.78); font-size: calc(13px * var(--ui)); line-height: 1.45; }
    .endActions{ display:flex; gap: calc(10px * var(--ui)); justify-content:center; flex-wrap:wrap; }

    /* ---------- Modals ---------- */
    .modal{
      position:absolute; inset:0;
      display:none;
      z-index: 70;
      pointer-events:auto;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
    }
    .modal .sheet{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      width:min(520px, 92vw);
      border-radius: calc(22px * var(--ui));
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.34);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal.full .sheet{
      width: min(820px, 96vw);
      max-height: min(92vh, 860px);
    }
    .modal .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: calc(12px * var(--ui)) calc(14px * var(--ui));
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
    }
    .modal .head b{ font-size: calc(14px * var(--ui)); letter-spacing:.2px; }
    .xBtn{
      width:calc(40px * var(--ui));height:calc(40px * var(--ui));
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      position: relative;
      z-index: 1;
    }
    .modal .body{
      padding: calc(14px * var(--ui)) calc(14px * var(--ui)) calc(16px * var(--ui));
      overflow:auto;
      max-height: min(78vh, 720px);
      -webkit-overflow-scrolling: touch;
    }

    /* Settings rows */
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: calc(12px * var(--ui));
      padding: calc(10px * var(--ui)) calc(10px * var(--ui));
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      border-radius: calc(16px * var(--ui));
      margin-bottom: calc(10px * var(--ui));
      backdrop-filter: blur(10px);
    }
    .row .label{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .row .label b{ font-size: calc(13px * var(--ui)); }
    .row .label span{ font-size: calc(12px * var(--ui)); color: rgba(219,231,255,.72); }
    .toggle{ display:flex; align-items:center; gap: calc(10px * var(--ui)); flex: 0 0 auto; }
    .stateText{
      font-size: calc(12px * var(--ui));
      font-weight: 900;
      letter-spacing: .6px;
      color: rgba(219,231,255,.82);
      min-width: calc(64px * var(--ui));
      text-align:right;
    }
    .switchBtn{
      appearance:none;border:0;padding:0;margin:0;background: transparent;
      cursor:pointer;border-radius: 999px;outline:none;
    }
    .switch{
      width: calc(54px * var(--ui));
      height: calc(30px * var(--ui));
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      position:relative;
      transition: background .18s ease, border-color .18s ease, transform .12s ease;
    }
    .switch::after{
      content:"";
      position:absolute;
      top:50%;
      left: calc(4px * var(--ui));
      transform: translateY(-50%);
      width: calc(22px * var(--ui));
      height: calc(22px * var(--ui));
      border-radius: 999px;
      background: rgba(255,255,255,.88);
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
      transition: left .18s ease, background .18s ease;
    }
    .switch.on{ background: rgba(110,231,255,.20); border-color: rgba(110,231,255,.45); }
    .switch.on::after{
      left: calc(54px * var(--ui) - 22px * var(--ui) - 4px * var(--ui));
      background: rgba(255,255,255,.95);
    }
    .switchBtn:active .switch{ transform: scale(.98); }

    /* ---------- SIMPLE START MENU ---------- */
    .wizard{
      position:absolute; inset:0;
      display:none;
      z-index: 85;
      pointer-events:auto;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
    }
    .wizard .sheet{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      width: min(420px, 92vw);
      border-radius: calc(18px * var(--ui));
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      overflow:hidden;
      padding: calc(14px * var(--ui));
    }

    .wizSearchRow{
      position: relative;
      display:flex;
      align-items:center;
      gap: 10px;
      border: 2px solid rgba(255,255,255,.30);
      background: rgba(0,0,0,.20);
      border-radius: calc(12px * var(--ui));
      padding: calc(10px * var(--ui)) calc(12px * var(--ui));
      margin-bottom: calc(12px * var(--ui));
    }
    .wizSearchRow input{
      width:100%;
      border:0;
      outline:none;
      background: transparent;
      color: rgba(255,255,255,.92);
      font-size: calc(14px * var(--ui));
      font-weight: 700;
    }
    .wizSearchRow .icon{
      opacity:.85;
      font-size: calc(16px * var(--ui));
      user-select:none;
    }

    .wizList{
      max-height: min(38vh, 360px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-right: 6px;
      margin-bottom: calc(12px * var(--ui));
    }
    .wizItem{
      width:100%;
      border:2px solid rgba(255,255,255,.30);
      background: rgba(0,0,0,.14);
      border-radius: calc(12px * var(--ui));
      padding: calc(12px * var(--ui));
      margin-bottom: calc(10px * var(--ui));
      cursor:pointer;
      font-weight: 900;
      font-size: calc(18px * var(--ui));
      text-align:center;
      color: rgba(255,255,255,.92);
      user-select:none;
    }
    .wizItem.active{
      border-color: rgba(110,231,255,.55);
      box-shadow: 0 0 0 3px rgba(110,231,255,.12);
    }

    .wizFooter{
      display:flex;
      justify-content:center;
      gap: calc(10px * var(--ui));
      padding-top: calc(6px * var(--ui));
    }
    .wizBtn{
      min-width: calc(140px * var(--ui));
      border-radius: calc(12px * var(--ui));
      padding: calc(10px * var(--ui)) calc(14px * var(--ui));
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight: 900;
      font-size: calc(15px * var(--ui));
      cursor:pointer;
      user-select:none;
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 50px rgba(0,0,0,.30);
    }
    .wizBtn.primary{
      border-color: rgba(110,231,255,.28);
      background: linear-gradient(135deg, rgba(110,231,255,.22), rgba(201,166,106,.18));
      box-shadow:
        0 14px 55px rgba(0,0,0,.38),
        0 0 0 3px rgba(110,231,255,.10);
    }
    .wizBtn:disabled{
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
    }

    .wizFooter.split{ justify-content:space-between; }
    .wizBtn.small{ min-width: calc(140px * var(--ui)); }

    /* Step visibility */
    .wizStep{ display:none; }
    .wizStep.active{ display:block; }

    /* Verse list uses same button look */
    .wizVerseItem{
      width:100%;
      border:2px solid rgba(255,255,255,.30);
      background: rgba(0,0,0,.14);
      border-radius: calc(12px * var(--ui));
      padding: calc(12px * var(--ui));
      margin-bottom: calc(10px * var(--ui));
      cursor:pointer;
      font-weight: 900;
      font-size: calc(18px * var(--ui));
      text-align:center;
      color: rgba(255,255,255,.92);
      user-select:none;
    }
    .wizVerseItem.active{
      border-color: rgba(110,231,255,.55);
      box-shadow: 0 0 0 3px rgba(110,231,255,.12);
    }

    /* ---------- Info ---------- */
    .infoFull{
      position:absolute;inset:0;display:none;z-index:80;
      pointer-events:auto;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
    }
    .infoFull .panel{position:absolute;inset:0;display:flex;flex-direction:column;background: rgba(0,0,0,.34);backdrop-filter: blur(14px);}
    .infoFull .topbar{display:flex;justify-content:flex-end;padding:calc(12px * var(--ui)) calc(14px * var(--ui));border-bottom:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.18);}
    .infoFull .close{
      width:calc(40px * var(--ui));height:calc(40px * var(--ui));
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
    }
    .infoFull .content{flex:1;display:flex;flex-direction:column;overflow:hidden;}
    .infoFull .media{width:100%;height:44%;min-height:calc(180px * var(--ui));background:#05060a;display:none;align-items:center;justify-content:center;overflow:hidden;}
    .infoFull .media iframe,.infoFull .media video,.infoFull .media img{width:100%;height:100%;display:block;object-fit:contain;background:#05060a;border:0;}
    .infoFull .text{flex:1;overflow:auto;padding:calc(14px * var(--ui)) calc(16px * var(--ui));font-size:calc(14px * var(--ui));line-height:1.55;white-space:pre-wrap;}

    .tapToUnmute{
      position:absolute; inset:0;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.40);
      backdrop-filter: blur(2px);
      z-index: 60;
      pointer-events:auto;
    }
    .tapToUnmute .box{
      padding: calc(14px * var(--ui));
      border-radius: calc(16px * var(--ui));
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      text-align:center;
      box-shadow: var(--shadow);
      max-width: calc(360px * var(--ui));
    }
    .tapToUnmute b{display:block;margin-bottom:6px}
    .tapToUnmute span{font-size:calc(12px * var(--ui));color:rgba(219,231,255,.82);line-height:1.4}

    /* ---------- Demo ---------- */
    .demo{
      position:absolute; inset:0;
      display:none;
      z-index: 999;
      pointer-events:auto;
    }
    .demo .inner{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      width: min(520px, 92vw);
      border-radius: calc(22px * var(--ui));
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.34);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .demo .top{
      padding: calc(14px * var(--ui)) calc(14px * var(--ui));
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: calc(10px * var(--ui));
    }
    .demo .top b{ font-size: calc(14px * var(--ui)); letter-spacing:.2px; }
    .demo .body{
      padding: calc(14px * var(--ui)) calc(14px * var(--ui)) calc(16px * var(--ui));
    }
    .demo .line{
      font-size: calc(13px * var(--ui));
      color: rgba(219,231,255,.86);
      line-height: 1.45;
      margin: 0 0 calc(12px * var(--ui));
    }
    .demo .mini{
      display:flex;
      gap: calc(10px * var(--ui));
      align-items:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      border-radius: calc(16px * var(--ui));
      padding: calc(12px * var(--ui));
      margin-bottom: calc(12px * var(--ui));
    }
    .demoHand{
      font-size: calc(20px * var(--ui));
      opacity: .95;
      animation: demoSwipe 1.6s ease-in-out infinite;
    }
    @keyframes demoSwipe{
      0%{ transform: translateY(10px); opacity: .55; }
      35%{ transform: translateY(-14px); opacity: 1; }
      55%{ transform: translateY(-14px); opacity: 1; }
      100%{ transform: translateY(10px); opacity: .55; }
    }
    .demo .actions{
      display:flex;
      justify-content:flex-end;
      gap: calc(10px * var(--ui));
      margin-top: calc(10px * var(--ui));
    }

    /* Highlight styles */
    .hl, .hlGold{
      position:relative !important;
      z-index: 99999 !important;
      filter: none !important;
      opacity: 1 !important;
      pointer-events:auto !important;
      transform: translateZ(0);
      will-change: box-shadow, transform, border-color, background, opacity;
    }
    .hl{
      border-color: rgba(110,231,255,.55) !important;
      background: rgba(110,231,255,.12) !important;
      animation: pulseHL 1.45s ease-in-out infinite;
    }
    .hlGold{
      border-color: rgba(201,166,106,.60) !important;
      background: rgba(201,166,106,.10) !important;
      animation: pulseGold 1.45s ease-in-out infinite;
    }

    @keyframes pulseHL{
      0%{
        box-shadow:
          0 0 0 3px rgba(110,231,255,.14),
          0 0 0 8px rgba(110,231,255,.06),
          0 14px 55px rgba(0,0,0,.42);
        transform: scale(1);
        opacity: .96;
      }
      50%{
        box-shadow:
          0 0 0 3px rgba(110,231,255,.26),
          0 0 0 10px rgba(110,231,255,.12),
          0 0 28px rgba(110,231,255,.14),
          0 18px 65px rgba(0,0,0,.48);
        transform: scale(1.04);
        opacity: 1;
      }
      100%{
        box-shadow:
          0 0 0 3px rgba(110,231,255,.14),
          0 0 0 8px rgba(110,231,255,.06),
          0 14px 55px rgba(0,0,0,.42);
        transform: scale(1);
        opacity: .96;
      }
    }
    @keyframes pulseGold{
      0%{
        box-shadow:
          0 0 0 3px rgba(201,166,106,.14),
          0 0 0 8px rgba(201,166,106,.06),
          0 14px 55px rgba(0,0,0,.42);
        transform: scale(1);
        opacity: .96;
      }
      50%{
        box-shadow:
          0 0 0 3px rgba(201,166,106,.26),
          0 0 0 10px rgba(201,166,106,.12),
          0 0 28px rgba(201,166,106,.14),
          0 18px 65px rgba(0,0,0,.48);
        transform: scale(1.04);
        opacity: 1;
      }
      100%{
        box-shadow:
          0 0 0 3px rgba(201,166,106,.14),
          0 0 0 8px rgba(201,166,106,.06),
          0 14px 55px rgba(0,0,0,.42);
        transform: scale(1);
        opacity: .96;
      }
    }

    @media (prefers-reduced-motion: reduce){
      .demoHand{animation:none}
      .hl,.hlGold{animation:none}
    }
  </style>
</head>

<body>
<div class="app">
  <section class="viewer" id="viewer">
    <div class="stage">
      <div class="frame" id="frame">

        <div class="progress dimTarget" id="progressWrap"><div class="bar" id="pbar"></div></div>

        <div class="fallbackBg dimTarget" id="fallbackBg"></div>

        <!-- no controls + best-effort download suppression -->
        <video class="bg dimTarget" id="bg"
               muted loop playsinline
               disablepictureinpicture
               controlslist="nodownload noremoteplayback noplaybackrate"
               oncontextmenu="return false;"></video>

        <div class="vignette dimTarget" id="vignette"></div>

        <div class="overlayTop dimTarget" id="overlayTop">
          <div class="leftTop"></div>
          <div class="rightTop">
            <button class="gearBtn" id="btnGear" type="button" title="Settings">‚öôÔ∏è</button>
            <button class="helpBtn" id="btnHelp" type="button" title="Help">?</button>
          </div>
        </div>

        <div class="pausePill dimTarget" id="pausePill">Paused</div>

        <div class="textArea dimTarget" id="textArea"></div>

        <div class="badge dimTarget" id="badge">
          <div class="badgeRow">
            <div></div>

            <div class="navBlock" id="navBlock">
              <div class="navCircle" id="navCircle" title="Choose Surah & Verse">
                <div class="circleContent">
                  <div class="lab">VERSE</div>
                  <div class="num" id="circleNum">‚Äî</div>
                </div>
              </div>
              <div class="surahOutside" id="surahName">Tap VERSE to choose</div>
            </div>

            <div class="infoOrb" id="infoOrb" title="More information">
              <div class="i">i</div>
            </div>
          </div>
        </div>

        <div class="endOverlay" id="endOverlay" aria-hidden="true">
          <div class="endCard">
            <h3>End of Surah</h3>
            <p>Autoplay reached the last verse. Restart from verse 1?</p>
            <div class="endActions">
              <button class="btn primary big" id="restartBtn">Restart Surah</button>
              <button class="btn big" id="endBackBtn">Choose another Surah</button>
            </div>
          </div>
        </div>

        <!-- Settings -->
        <div class="modal" id="settingsModal" aria-hidden="true">
          <div class="sheet" role="dialog" aria-modal="true" aria-label="Settings">
            <div class="head">
              <b>Settings</b>
              <button class="xBtn" id="settingsClose" type="button" title="Close">‚úï</button>
            </div>
            <div class="body">
              <div class="row">
                <div class="label">
                  <b>Arabic</b>
                  <span>Show / hide Arabic text</span>
                </div>
                <div class="toggle">
                  <div class="stateText" id="stArabic">ON</div>
                  <button class="switchBtn" id="swArabicBtn" type="button" aria-label="Toggle Arabic">
                    <div class="switch on" id="swArabic" role="switch" aria-checked="true"></div>
                  </button>
                </div>
              </div>

              <div class="row">
                <div class="label">
                  <b>Background</b>
                  <span>Show / hide background video</span>
                </div>
                <div class="toggle">
                  <div class="stateText" id="stBg">ON</div>
                  <button class="switchBtn" id="swBgBtn" type="button" aria-label="Toggle Background">
                    <div class="switch on" id="swBg" role="switch" aria-checked="true"></div>
                  </button>
                </div>
              </div>

              <div class="row">
                <div class="label">
                  <b>Autoplay</b>
                  <span>Auto-advance to next verse</span>
                </div>
                <div class="toggle">
                  <div class="stateText" id="stAuto">ON</div>
                  <button class="switchBtn" id="swAutoBtn" type="button" aria-label="Toggle Autoplay">
                    <div class="switch on" id="swAuto" role="switch" aria-checked="true"></div>
                  </button>
                </div>
              </div>

              <div class="row" style="margin-bottom:0">
                <div class="label">
                  <b>Fullscreen</b>
                  <span>Immersive fullscreen view</span>
                </div>
                <div class="toggle">
                  <div class="stateText" id="stFS">OFF</div>
                  <button class="switchBtn" id="swFSBtn" type="button" aria-label="Toggle Fullscreen">
                    <div class="switch" id="swFS" role="switch" aria-checked="false"></div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SIMPLE Wizard -->
        <div class="wizard" id="wizard" aria-hidden="true">
          <div class="sheet" role="dialog" aria-modal="true" aria-label="Choose surah and verse">
            <!-- Step 1: Surah -->
            <div class="wizStep" id="wizStep1">
              <div class="wizSearchRow" id="surahSearchRow">
                <!-- readonly by default: keyboard only opens when row is clicked -->
                <input id="wizSurahSearch" placeholder="Type surah name..." autocomplete="off" readonly inputmode="search"/>
                <div class="icon">üîç</div>
              </div>
              <div class="wizList" id="wizSurahList"></div>
              <div class="wizFooter">
                <button class="wizBtn primary" id="wizNext">Next</button>
              </div>
            </div>

            <!-- Step 2: Verse -->
            <div class="wizStep" id="wizStep2">
              <div class="wizSearchRow" id="verseSearchRow">
                <!-- readonly by default: keyboard only opens when row is clicked -->
                <input id="wizVerseSearch" placeholder="Type verse..." autocomplete="off" readonly inputmode="numeric"/>
                <div class="icon">üîç</div>
              </div>
              <div class="wizList" id="wizVerseList"></div>
              <div class="wizFooter split">
                <button class="wizBtn" id="wizBack">Back</button>
                <button class="wizBtn primary" id="wizPlay">Play</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Info -->
        <div class="infoFull" id="infoFull" aria-hidden="true">
          <div class="panel" id="infoPanel">
            <div class="topbar">
              <button class="close" id="infoClose" type="button" title="Close">‚úï</button>
            </div>
            <div class="content">
              <div class="media" id="infoMedia"></div>
              <div class="text" id="infoText"></div>
            </div>
          </div>
        </div>

        <!-- Demo -->
        <div class="demo" id="demo" aria-hidden="true">
          <div class="inner">
            <div class="top">
              <b>Quick demo</b>
              <div style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace; font-size:12px; opacity:.9;" id="demoStep">1 / 4</div>
            </div>
            <div class="body">
              <p class="line" id="demoText">Swipe up/down to move between verses.</p>
              <div class="mini" id="demoMini">
                <div class="demoHand">‚òùÔ∏è</div>
                <div style="display:flex;flex-direction:column;gap:2px">
                  <div style="font-weight:900">Swipe</div>
                  <div style="font-size:12px;color:rgba(219,231,255,.80)">Up = next verse ‚Ä¢ Down = previous</div>
                </div>
              </div>
              <div class="actions">
                <button class="btn primary" id="demoNext" type="button">Next</button>
              </div>
            </div>
          </div>
        </div>

        <div class="tapToUnmute" id="tapToUnmute">
          <div class="box">
            <b>Tap to enable audio</b>
            <span>Browsers block autoplay audio until you interact.</span>
          </div>
        </div>

        <audio id="audio" preload="auto" playsinline></audio>
      </div>
    </div>
  </section>
</div>

<script>
  const el = (id)=>document.getElementById(id);
  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  const fmt = (s)=>String(s ?? '').trim();

  // Viewer
  const viewer = el('viewer');
  const frame = el('frame');
  const overlayTop = el('overlayTop');
  const bg = el('bg');
  const audio = el('audio');
  const pbar = el('pbar');

  // Text
  const textArea = el('textArea');
  let currentLayer = null;

  // Bottom nav
  const surahName = el('surahName');
  const navCircle = el('navCircle');
  const circleNum = el('circleNum');

  // Info
  const infoOrb = el('infoOrb');
  const infoFull = el('infoFull');
  const infoPanel = el('infoPanel');
  const infoClose = el('infoClose');
  const infoMedia = el('infoMedia');
  const infoText = el('infoText');

  // Top buttons
  const btnGear = el('btnGear');
  const btnHelp = el('btnHelp');
  const tapToUnmute = el('tapToUnmute');
  const pausePill = el('pausePill');

  // End overlay
  const endOverlay = el('endOverlay');
  const restartBtn = el('restartBtn');
  const endBackBtn = el('endBackBtn');

  // Settings
  const settingsModal = el('settingsModal');
  const settingsClose = el('settingsClose');
  const swArabicBtn = el('swArabicBtn');
  const swBgBtn = el('swBgBtn');
  const swAutoBtn = el('swAutoBtn');
  const swFSBtn = el('swFSBtn');
  const swArabic = el('swArabic');
  const swBg = el('swBg');
  const swAuto = el('swAuto');
  const swFS = el('swFS');
  const stArabic = el('stArabic');
  const stBg = el('stBg');
  const stAuto = el('stAuto');
  const stFS = el('stFS');

  // Wizard (simple)
  const wizard = el('wizard');
  const wizStep1 = el('wizStep1');
  const wizStep2 = el('wizStep2');
  const wizSurahSearch = el('wizSurahSearch');
  const wizSurahList = el('wizSurahList');
  const wizVerseSearch = el('wizVerseSearch');
  const wizVerseList = el('wizVerseList');
  const wizNext = el('wizNext');
  const wizBack = el('wizBack');
  const wizPlay = el('wizPlay');
  const surahSearchRow = el('surahSearchRow');
  const verseSearchRow = el('verseSearchRow');

  // Demo
  const demo = el('demo');
  const demoStep = el('demoStep');
  const demoText = el('demoText');
  const demoMini = el('demoMini');
  const demoNext = el('demoNext');

  // State
  let surahs = [];
  let current = null;
  let idx = 0;

  let showArabic = true;
  let showBackground = true;
  let autoplay = true;

  let paused = false;
  let infoOpen = false;
  let ended = false;

  let raf = null;
  let segTimer = null;

  let userInteracted = false;
  let suppressFrameTapUntil = 0;
  let activeClipUrl = "";

  // SWIPE
  let touchActive = false;
  let startY = 0, startX = 0;
  let lastTouchTime = 0;

  // Cache parsed surahs
  const surahCache = new Map();

  // Wizard selection
  let wizSelectedFile = "";
  let wizParsed = null;
  let wizVerseMax = 0;
  let wizVerseSet = new Set();
  let wizSelectedVerse = 1;

  // Demo state
  let demoIndex = 0;

  // ---------- Best-effort: block context menu / long-press menus ----------
  const killContext = (e)=>{ e.preventDefault(); e.stopPropagation(); return false; };
  document.addEventListener("contextmenu", killContext, {capture:true});
  frame.addEventListener("contextmenu", killContext, {capture:true});
  bg.addEventListener("contextmenu", killContext, {capture:true});

  // Some browsers show image/video ‚Äúsave‚Äù on long press via touch callout
  // This reduces it; cannot 100% stop OS-level actions in every browser.
  ["copy","cut","paste","selectstart","dragstart"].forEach(ev=>{
    document.addEventListener(ev, killContext, {capture:true});
  });

  function isLandscapeView(){
    const w = frame?.clientWidth || window.innerWidth;
    const h = frame?.clientHeight || window.innerHeight;
    return w > h;
  }

  function popFx(node){
    if (!node) return;
    node.classList.remove("pop");
    void node.offsetWidth;
    node.classList.add("pop");
  }

  function glowCircle(){
    navCircle.classList.remove("glow");
    void navCircle.offsetWidth;
    navCircle.classList.add("glow");
    setTimeout(()=>navCircle.classList.remove("glow"), 260);
  }

  function updateUIScale(){
    const w = frame.clientWidth || window.innerWidth;
    const h = frame.clientHeight || window.innerHeight;
    const minDim = Math.min(w,h);
    const ui = clamp(minDim / 980, 0.92, 1.10);
    document.documentElement.style.setProperty("--ui", ui.toFixed(3));
    if (current?.segments?.[idx]) refreshCurrentTextAndFit();
  }
  window.addEventListener("resize", updateUIScale);
  window.addEventListener("orientationchange", updateUIScale);

  function stopTimers(){
    if (segTimer){ clearTimeout(segTimer); segTimer=null; }
    if (raf){ cancelAnimationFrame(raf); raf=null; }
  }

  function syncPauseUI(){
    pausePill.style.display = (paused && !ended) ? "inline-flex" : "none";
  }

  function setEnded(on){
    ended = !!on;
    endOverlay.style.display = ended ? "grid" : "none";
    endOverlay.setAttribute("aria-hidden", ended ? "false" : "true");
    syncPauseUI();
  }

  function ensureUserGesture(){
    if (userInteracted) return;
    userInteracted = true;
    bg.muted = true;
    bg.loop = true;
    bg.playsInline = true;
    bg.play().catch(()=>{});
  }

  function setPaused(next){
    paused = !!next;
    syncPauseUI();

    if (paused){
      stopTimers();
      try{ audio.pause(); }catch(e){}
      try{ bg.pause(); }catch(e){}
      return;
    }

    if (showBackground) bg.play().catch(()=>{});

    if (audio.getAttribute("src")){
      audio.play().then(()=> tapToUnmute.style.display="none")
        .catch(()=> tapToUnmute.style.display="grid");
    }

    const seg = current?.segments?.[idx];
    if (seg) startProgressLoop(seg);
  }

  function togglePause(){
    if (!current) return;
    if (ended) return;
    setPaused(!paused);
  }

  async function loadSurahs(){
    try{
      const r = await fetch("/surah-index.json", { cache:"no-store" });
      if (!r.ok) throw new Error("missing surah-index.json");
      const j = await r.json();
      surahs = Array.isArray(j.surahs) ? j.surahs : [];
    }catch(e){
      surahs = [];
      console.error(e);
    }
  }

  function stopPlayback(){
    stopTimers();
    infoOpen = false;
    paused = false;
    activeClipUrl = "";
    setEnded(false);
    syncPauseUI();

    try{ audio.pause(); }catch(e){}
    try{ bg.pause(); }catch(e){}

    textArea.innerHTML = "";
    currentLayer = null;
    circleNum.textContent = "‚Äî";
    surahName.textContent = "Tap VERSE to choose";
    infoOrb.style.display = "none";
  }

  function setSwitch(sw, st, on){
    sw.classList.toggle("on", !!on);
    sw.setAttribute("aria-checked", !!on ? "true" : "false");
    st.textContent = on ? "ON" : "OFF";
  }

  function isFullscreen(){
    return !!(document.fullscreenElement || document.webkitFullscreenElement);
  }

  function setToggleUI(){
    setSwitch(swArabic, stArabic, showArabic);
    setSwitch(swBg, stBg, showBackground);
    setSwitch(swAuto, stAuto, autoplay);
    setSwitch(swFS, stFS, isFullscreen());

    bg.classList.toggle("hidden", !showBackground);
    if (currentLayer){
      const ar = currentLayer.querySelector(".arabic");
      if (ar) ar.classList.toggle("hidden", !showArabic);
    }

    // Don‚Äôt auto-play bg when paused
    if (userInteracted && showBackground && !paused){
      bg.play().catch(()=>{});
    }
    if (paused){
      try{ bg.pause(); }catch(_){}
    }
  }

  function computeTextScale(){
    const w = frame.clientWidth || window.innerWidth;
    const h = frame.clientHeight || window.innerHeight;
    const minDim = Math.min(w,h);
    return clamp(minDim / 980, 0.95, 1.10);
  }

  function setVideo(url, brightness){
    const u = fmt(url);
    const b = clamp(Number(brightness ?? 0.55), 0.2, 1.0);
    frame.style.setProperty("--videoBright", b);

    if (!u){
      bg.removeAttribute("src");
      bg.load();
      return;
    }
    if (bg.getAttribute("src") !== u){
      bg.src = u;
      bg.load();
    }
    // Only play if not paused
    if (userInteracted && !paused && showBackground){
      bg.play().catch(()=>{});
    }
    if (paused){
      try{ bg.pause(); }catch(_){}
    }
  }

  function segmentHasInfo(seg){
    const t = fmt(seg?.info?.text);
    const m = fmt(seg?.info?.media);
    return !!(t || m);
  }

  function setInfoOrbVisible(visible){
    if (infoOpen){
      infoOrb.style.display = "none";
      return;
    }
    infoOrb.style.display = visible ? "flex" : "none";
  }

  function isYouTubeUrl(u){
    const s = fmt(u);
    return /youtu\.be\/|youtube\.com\/watch\?v=|youtube\.com\/embed\//i.test(s);
  }
  function toYouTubeEmbed(u){
    const s = fmt(u);
    if (!s) return "";
    if (/youtube\.com\/embed\//i.test(s)) return s;
    let id = "";
    const m1 = s.match(/v=([a-zA-Z0-9_-]+)/);
    const m2 = s.match(/youtu\.be\/([a-zA-Z0-9_-]+)/);
    if (m1) id = m1[1];
    if (m2) id = m2[1];
    return id ? `https://www.youtube.com/embed/${id}` : s;
  }
  function isImageUrl(u){ return /\.(png|jpg|jpeg|webp|gif)$/i.test(fmt(u)); }
  function isVideoUrl(u){ return /\.(mp4|webm|ogg)$/i.test(fmt(u)); }

  function renderMedia(mediaUrl){
    infoMedia.innerHTML = "";
    const media = fmt(mediaUrl);
    if (!media){
      infoMedia.style.display = "none";
      return;
    }
    infoMedia.style.display = "flex";

    if (isYouTubeUrl(media)){
      const iframe = document.createElement("iframe");
      iframe.src = toYouTubeEmbed(media);
      iframe.setAttribute("allowfullscreen", "true");
      iframe.setAttribute("allow", "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture");
      infoMedia.appendChild(iframe);
      return;
    }
    if (isImageUrl(media)){
      const img = document.createElement("img");
      img.src = media;
      infoMedia.appendChild(img);
      return;
    }
    if (isVideoUrl(media)){
      const v = document.createElement("video");
      v.src = media;
      v.controls = true;
      v.playsInline = true;
      v.setAttribute("controlslist","nodownload noremoteplayback noplaybackrate");
      v.disablePictureInPicture = true;
      v.addEventListener("contextmenu", killContext, {capture:true});
      infoMedia.appendChild(v);
      return;
    }
    const iframe = document.createElement("iframe");
    iframe.src = media;
    infoMedia.appendChild(iframe);
  }

  function showInfoForSegment(seg){
    if (!segmentHasInfo(seg)) return;
    setPaused(true);
    renderMedia(seg.info?.media);
    infoText.textContent = fmt(seg.info?.text);
    infoFull.style.display = "block";
    infoFull.setAttribute("aria-hidden","false");
    infoOpen = true;
    infoOrb.style.display = "none";
  }

  function hideInfo(){
    infoFull.style.display = "none";
    infoFull.setAttribute("aria-hidden","true");
    infoOpen = false;
    const seg = current?.segments?.[idx];
    setInfoOrbVisible(segmentHasInfo(seg));
    setPaused(false);
  }

  function pickEnglish(seg){
    const land = isLandscapeView();
    const a = fmt(seg.en_land);
    const p = fmt(seg.en_port);
    const o = fmt(seg.en_orig);
    if (land) return a || o || p || "‚Äî";
    return p || o || a || "‚Äî";
  }

  function fitLayerToAvoidOverlap(layer){
    if (!layer) return;
    requestAnimationFrame(()=>{
      const ui = Number(getComputedStyle(document.documentElement).getPropertyValue("--ui")) || 1;
      const margin = 14 * ui;
      const navRect = navCircle.getBoundingClientRect();
      const layerRect = layer.getBoundingClientRect();
      const maxBottom = navRect.top - margin;
      if (layerRect.bottom <= maxBottom) return;

      const en = layer.querySelector(".english");
      const ar = layer.querySelector(".arabic");
      if (!en) return;

      const getPx = (el)=> parseFloat((el.style.fontSize || "0").replace("px","")) || 0;
      let enSize = getPx(en);
      let arSize = ar ? getPx(ar) : 0;

      for (let k=0; k<10; k++){
        enSize = Math.max(16, enSize * 0.92);
        if (ar) arSize = Math.max(16, arSize * 0.92);

        en.style.fontSize = enSize.toFixed(2) + "px";
        if (ar) ar.style.fontSize = arSize.toFixed(2) + "px";

        const r = layer.getBoundingClientRect();
        if (r.bottom <= maxBottom) break;
      }
    });
  }

  function makeLayer(seg){
    const layer = document.createElement("div");
    layer.className = "layer in";

    const ar = document.createElement("div");
    ar.className = "arabic" + (showArabic ? "" : " hidden");
    ar.textContent = fmt(seg.text_ar) || "‚Äî";

    const en = document.createElement("div");
    en.className = "english";
    en.textContent = pickEnglish(seg);

    const scale = computeTextScale();
    const basePort = Number(seg.fonts?.port ?? current?.json?.layout?.portFont ?? 35);

    en.style.fontSize = clamp(basePort * scale, 18, 78) + "px";
    ar.style.fontSize = clamp(Math.round(basePort * 0.72 * scale), 18, 62) + "px";

    layer.appendChild(ar);
    layer.appendChild(en);

    fitLayerToAvoidOverlap(layer);
    return layer;
  }

  function animateToSegment(seg){
    const nextLayer = makeLayer(seg);
    textArea.appendChild(nextLayer);

    if (currentLayer){
      currentLayer.classList.remove("in");
      currentLayer.classList.add("out");
      setTimeout(()=>{
        if (currentLayer && currentLayer.parentNode) currentLayer.parentNode.removeChild(currentLayer);
        currentLayer = nextLayer;
      }, 230);
    } else {
      currentLayer = nextLayer;
    }
  }

  function refreshCurrentTextAndFit(){
    const seg = current?.segments?.[idx];
    if (!seg || !currentLayer) return;

    const en = currentLayer.querySelector(".english");
    const ar = currentLayer.querySelector(".arabic");
    if (en) en.textContent = pickEnglish(seg);

    const scale = computeTextScale();
    const basePort = Number(seg.fonts?.port ?? current?.json?.layout?.portFont ?? 35);
    if (en) en.style.fontSize = clamp(basePort * scale, 18, 78) + "px";
    if (ar) ar.style.fontSize = clamp(Math.round(basePort * 0.72 * scale), 18, 62) + "px";

    fitLayerToAvoidOverlap(currentLayer);
  }

  // ---------- Media Session best effort ----------
  function supportsMediaSession(){ return "mediaSession" in navigator; }
  function updateMediaSession(){
    if (!supportsMediaSession() || !current) return;
    try{
      navigator.mediaSession.metadata = new MediaMetadata({
        title: current.title || "Quran Viz Shorts",
        artist: "Quran Viz",
        album: "Shorts",
      });
      navigator.mediaSession.setActionHandler("play", async ()=>{
        ensureUserGesture();
        if (!paused) { await audio.play().catch(()=>{}); return; }
        setPaused(false);
      });
      navigator.mediaSession.setActionHandler("pause", ()=>{ setPaused(true); });

      // IMPORTANT: allow track skip even while paused? keep consistent with swipe requirement:
      navigator.mediaSession.setActionHandler("previoustrack", ()=>{ ensureUserGesture(); prev(true); });
      navigator.mediaSession.setActionHandler("nexttrack", ()=>{ ensureUserGesture(); next(true); });
    }catch(_){}
  }

  document.addEventListener("visibilitychange", ()=>{
    if (!autoplay) return;
    if (paused) return;
    if (!audio.getAttribute("src")) return;
    if (!document.hidden){
      audio.play().then(()=>{ tapToUnmute.style.display="none"; })
        .catch(()=>{});
    }
  });

  async function loadSurahParsed(entry){
    const key = entry.file;
    if (surahCache.has(key)) return surahCache.get(key);

    const r = await fetch(entry.file, { cache:"no-store" });
    if (!r.ok) throw new Error("json load fail");
    const json = await r.json();

    const segs = Array.isArray(json?.segments) ? json.segments : [];
    const segments = segs
      .filter(s => (fmt(s.type).toLowerCase() !== "bismillah"))
      .map(s => ({
        id: fmt(s.id),
        ayah: s.ayah,
        start: Number(s.start),
        end: Number(s.end),
        duration: Number(s.duration) || (isFinite(s.start) && isFinite(s.end) ? (Number(s.end)-Number(s.start)) : 0),
        text_ar: s.text_ar || "",
        en_orig: s.en_orig || "",
        en_land: s.en_land || "",
        en_port: s.en_port || "",
        fonts: s.fonts || {},
        video: s.video || { url:"", brightness: 0.55 },
        clip_audio_url: fmt(s.audio?.url || ""),
        legacy_audio_url: fmt(json?.meta?.audio_url || ""),
        info: s.info ? { text: s.info.text ?? "", media: s.info.media ?? "" } : null
      }))
      .filter(s => s.duration > 0.02)
      .sort((a,b)=> (a.start||0)-(b.start||0));

    if (!segments.length) throw new Error("no segments");

    const versesSet = new Set();
    let maxAyah = 0;
    for (const s of segments){
      const a = Number(s.ayah);
      if (isFinite(a)){
        versesSet.add(a);
        if (a > maxAyah) maxAyah = a;
      }
    }

    const parsed = {
      title: fmt(entry.title) || fmt(json?.meta?.surah) || fmt(entry.file),
      file: entry.file,
      entry,
      json,
      segments,
      verseSet: versesSet,
      verseMax: maxAyah
    };

    surahCache.set(key, parsed);
    return parsed;
  }

  function findFirstSegmentIndexByAyah(parsed, ayah){
    const a = Number(ayah);
    if (!isFinite(a)) return 0;
    const i = parsed.segments.findIndex(s => Number(s.ayah) === a);
    return i >= 0 ? i : 0;
  }

  async function openSurah(entry, opts = {}){
    stopPlayback();

    try{
      const parsed = await loadSurahParsed(entry);
      current = parsed;
      idx = 0;

      showArabic = true;
      showBackground = true;
      autoplay = true;
      paused = false;
      infoOpen = false;
      setEnded(false);
      syncPauseUI();

      bg.muted = true; bg.loop = true; bg.playsInline = true;

      ensureUserGesture();
      if (showBackground) bg.play().catch(()=>{});

      const startAyah = opts.startAyah;
      if (startAyah != null){
        const j = findFirstSegmentIndexByAyah(current, startAyah);
        idx = clamp(j, 0, current.segments.length-1);
      }

      applySegment(idx, true);
      updateMediaSession();

      if (!sessionStorage.getItem("qvz_demo_seen")){
        sessionStorage.setItem("qvz_demo_seen","1");
        setTimeout(()=> startDemo(true), 380);
      }

    }catch(e){
      console.error(e);
    }
  }

  function applySegment(i, immediate){
    if (!current) return;

    setEnded(false);

    const segs = current.segments;
    idx = clamp(i, 0, segs.length-1);
    const seg = segs[idx];

    surahName.textContent = (current.title || "‚Äî").toUpperCase();
    circleNum.textContent = String(seg.ayah ?? "‚Äî");

    setVideo(seg.video?.url, seg.video?.brightness);
    animateToSegment(seg);
    setInfoOrbVisible(segmentHasInfo(seg));

    pbar.style.width = "0%";
    setToggleUI();

    // If paused, keep everything paused but still let user navigate verses
    if (paused){
      try{ audio.pause(); }catch(_){}
      try{ bg.pause(); }catch(_){}
      return;
    }

    startSegment(seg, immediate);
    updateMediaSession();
  }

  function startSegment(seg, immediate){
    stopTimers();
    audio.loop = false;

    const go = async ()=>{
      if (paused) return;

      if (seg.clip_audio_url){
        if (activeClipUrl !== seg.clip_audio_url){
          activeClipUrl = seg.clip_audio_url;
          audio.pause();
          audio.currentTime = 0;
          audio.src = seg.clip_audio_url;
          audio.load();
        } else {
          try{ audio.currentTime = 0; }catch(e){}
        }

        try{
          await audio.play();
          tapToUnmute.style.display = "none";
        }catch(e){
          tapToUnmute.style.display = "grid";
          return;
        }

        if (showBackground) bg.play().catch(()=>{});
        startProgressLoop(seg);
        return;
      }

      if (seg.legacy_audio_url){
        if (audio.getAttribute("src") !== seg.legacy_audio_url){
          activeClipUrl = "";
          audio.src = seg.legacy_audio_url;
          audio.load();
        }

        try{
          if (audio.fastSeek) audio.fastSeek(seg.start || 0);
          else audio.currentTime = seg.start || 0;
        }catch(e){}

        try{
          await audio.play();
          tapToUnmute.style.display = "none";
        }catch(e){
          tapToUnmute.style.display = "grid";
          return;
        }

        if (showBackground) bg.play().catch(()=>{});
        startProgressLoop(seg);
        return;
      }

      const dur = clamp(seg.duration * 1000, 900, 25000);
      const startAt = performance.now();
      const tick = (now)=>{
        if (paused) return;
        const u = (now - startAt) / dur;
        pbar.style.width = `${clamp(u,0,1)*100}%`;

        if (u >= 1){
          if (autoplay) next(false);
          else startSegment(seg, true);
          return;
        }
        raf = requestAnimationFrame(tick);
      };
      raf = requestAnimationFrame(tick);
    };

    if (immediate) go();
    else segTimer = setTimeout(go, 0);
  }

  function loopCurrent(seg){
    if (paused) return;
    pbar.style.width = "0%";

    if (seg.clip_audio_url){
      try{ audio.currentTime = 0; }catch(e){}
      audio.play().catch(()=> tapToUnmute.style.display="grid");
      startProgressLoop(seg);
      return;
    }

    if (seg.legacy_audio_url){
      try{
        if (audio.fastSeek) audio.fastSeek(seg.start || 0);
        else audio.currentTime = seg.start || 0;
      }catch(e){}
      audio.play().catch(()=> tapToUnmute.style.display="grid");
      startProgressLoop(seg);
      return;
    }

    startSegment(seg, true);
  }

  function startProgressLoop(seg){
    stopTimers();

    const isClip = !!seg.clip_audio_url;
    const start = isClip ? 0 : (seg.start || 0);

    const getClipEnd = ()=>{
      const d = Number(audio.duration);
      if (isFinite(d) && d > 0.05) return d;
      const fallback = Number(seg.duration) || 0;
      return fallback > 0.05 ? fallback : 1.0;
    };

    const end = isClip ? getClipEnd() : (seg.end || (start + (seg.duration||1)));
    const safeEnd = (end > start + 0.05) ? end : (start + 1.0);

    const tick = ()=>{
      if (paused) return;

      const t = audio.currentTime || 0;
      const u = (t - start) / (safeEnd - start);
      pbar.style.width = `${clamp(u,0,1)*100}%`;

      if (t >= safeEnd - 0.03){
        if (autoplay) next(false);
        else loopCurrent(seg);
        return;
      }
      raf = requestAnimationFrame(tick);
    };

    raf = requestAnimationFrame(tick);
  }

  function reachEndOfSurah(){
    stopTimers();
    try{ audio.pause(); }catch(e){}
    try{ bg.pause(); }catch(e){}

    paused = true;
    setEnded(true);
    syncPauseUI();
  }

  function restartSurah(){
    if (!current) return;
    ensureUserGesture();
    setEnded(false);
    paused = false;
    syncPauseUI();
    applySegment(0, true);
  }

  // allowWhilePaused: true lets swipe change verse even if paused
  function next(allowWhilePaused){
    if (!current) return;
    if (infoOpen || ended) return;

    const n = idx + 1;
    if (n >= current.segments.length){
      if (autoplay && !paused) { reachEndOfSurah(); }
      return;
    }

    // keep paused state; applySegment already respects it
    applySegment(n, true);
  }

  function prev(allowWhilePaused){
    if (!current) return;
    if (infoOpen || ended) return;
    applySegment(idx - 1, true);
  }

  function suppressFrameTap(){
    suppressFrameTapUntil = performance.now() + 350;
  }

  overlayTop.addEventListener("pointerdown", (e)=>{
    suppressFrameTap();
    e.stopPropagation();
  }, {passive:false});

  function handleSwipe(dy, dx){
    if (infoOpen) return;
    if (ended) return;
    if (demo.style.display === "block") return;
    if (wizard.style.display === "block") return;

    if (Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 45){
      ensureUserGesture();
      suppressFrameTap();
      // IMPORTANT: allow swipe even while paused
      if (dy < 0) next(true);
      else prev(true);
      return true;
    }
    return false;
  }

  frame.addEventListener("touchstart", (e)=>{
    if (e.touches.length !== 1) return;
    touchActive = true;
    startY = e.touches[0].clientY;
    startX = e.touches[0].clientX;
    lastTouchTime = performance.now();
  }, {passive:true});

  frame.addEventListener("touchmove", (e)=>{
    if (!touchActive) return;
    if (e.touches.length !== 1) { touchActive = false; return; }

    const dy = e.touches[0].clientY - startY;
    const dx = e.touches[0].clientX - startX;

    if (Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 8){
      e.preventDefault();
    }
  }, {passive:false});

  frame.addEventListener("touchend", (e)=>{
    if (!touchActive) return;
    touchActive = false;

    const ct = e.changedTouches && e.changedTouches[0];
    if (!ct) return;

    const dy = ct.clientY - startY;
    const dx = ct.clientX - startX;

    handleSwipe(dy, dx);
  }, {passive:true});

  frame.addEventListener("touchcancel", ()=>{ touchActive = false; }, {passive:true});

  frame.addEventListener("pointerdown", (e)=>{
    if (demo.style.display === "block") return;
    if (wizard.style.display === "block") return;
    if (performance.now() - lastTouchTime < 450) return;
    frame._pActive = true;
    frame._pStartY = e.clientY;
    frame._pStartX = e.clientX;
    frame._pId = e.pointerId;
    try{ frame.setPointerCapture(e.pointerId); }catch(_){}
  }, {passive:true});

  frame.addEventListener("pointerup", (e)=>{
    if (demo.style.display === "block") return;
    if (wizard.style.display === "block") return;
    if (performance.now() - lastTouchTime < 450) return;
    if (!frame._pActive || e.pointerId !== frame._pId) return;
    frame._pActive = false;

    const dy = e.clientY - frame._pStartY;
    const dx = e.clientX - frame._pStartX;
    handleSwipe(dy, dx);
  }, {passive:true});

  frame.addEventListener("click", ()=>{
    ensureUserGesture();
    if (!current) return;
    if (infoOpen) return;
    if (ended) return;
    if (demo.style.display === "block") return;
    if (wizard.style.display === "block") return;
    if (performance.now() < suppressFrameTapUntil) return;
    togglePause();
  });

  async function toggleFullscreen(force){
    suppressFrameTap();
    ensureUserGesture();
    try{
      const wantOn = (typeof force === "boolean") ? force : !isFullscreen();

      if (wantOn && !isFullscreen()){
        const target = frame;
        if (target.requestFullscreen) await target.requestFullscreen();
        else if (target.webkitRequestFullscreen) target.webkitRequestFullscreen();
      } else if (!wantOn && isFullscreen()){
        if (document.exitFullscreen) await document.exitFullscreen();
        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
      }
    }catch(_){}
  }

  function syncFullscreenState(){
    const on = isFullscreen();
    viewer.classList.toggle("immersive", on);
    setToggleUI();
    setTimeout(updateUIScale, 120);
  }
  document.addEventListener("fullscreenchange", syncFullscreenState);
  document.addEventListener("webkitfullscreenchange", syncFullscreenState);

  // Info handlers
  infoOrb.addEventListener("pointerdown", (e)=>{ suppressFrameTap(); e.stopPropagation(); }, {passive:false});
  infoOrb.addEventListener("click", (e)=>{
    suppressFrameTap();
    e.preventDefault();
    e.stopPropagation();
    ensureUserGesture();
    popFx(infoOrb);
    const seg = current?.segments?.[idx];
    if (seg) showInfoForSegment(seg);
  });

  infoClose.addEventListener("pointerdown", (e)=>{
    suppressFrameTap();
    e.preventDefault();
    e.stopPropagation();
  }, {passive:false});
  infoClose.addEventListener("click", (e)=>{
    suppressFrameTap();
    e.preventDefault();
    e.stopPropagation();
    popFx(infoClose);
    hideInfo();
  });

  infoFull.addEventListener("click", ()=>hideInfo());
  infoPanel.addEventListener("click", (e)=>e.stopPropagation());

  tapToUnmute.addEventListener("click", ()=>{
    ensureUserGesture();
    popFx(tapToUnmute.querySelector(".box"));
    audio.play().then(()=> tapToUnmute.style.display="none")
      .catch(()=> tapToUnmute.style.display="grid");
  });

  // End overlay buttons
  restartBtn.addEventListener("click", (e)=>{
    suppressFrameTap();
    e.preventDefault();
    e.stopPropagation();
    popFx(restartBtn);
    restartSurah();
  });

  endBackBtn.addEventListener("click", (e)=>{
    suppressFrameTap();
    e.preventDefault();
    e.stopPropagation();
    popFx(endBackBtn);
    openWizard(true);
  });

  // Keyboard
  window.addEventListener("keydown", (e)=>{
    if (e.key === "Escape"){
      if (infoOpen) hideInfo();
      else if (settingsModal.style.display === "block") closeSettings();
      else if (wizard.style.display === "block") closeWizard();
      else if (demo.style.display === "block") return;
      else if (ended) { setEnded(false); }
      else if (isFullscreen()) toggleFullscreen(false);
      return;
    }
    if (e.key === " "){
      ensureUserGesture();
      if (!current) return;
      if (infoOpen || ended || wizard.style.display==="block") return;
      togglePause();
      e.preventDefault();
      return;
    }
    if (e.key === "ArrowUp"){ ensureUserGesture(); if(current && wizard.style.display!=="block") next(true); }
    if (e.key === "ArrowDown"){ ensureUserGesture(); if(current && wizard.style.display!=="block") prev(true); }
    if (e.key.toLowerCase() === "f"){ toggleFullscreen(); }
  });

  // Settings
  function openSettings(){
    suppressFrameTap();
    ensureUserGesture();
    settingsModal.style.display = "block";
    settingsModal.setAttribute("aria-hidden","false");
    popFx(btnGear);
    setToggleUI();
  }
  function closeSettings(){
    settingsModal.style.display = "none";
    settingsModal.setAttribute("aria-hidden","true");
  }

  btnGear.addEventListener("click", (e)=>{
    e.preventDefault();
    e.stopPropagation();
    openSettings();
  });

  settingsClose.addEventListener("pointerdown", (e)=>{
    suppressFrameTap();
    e.preventDefault();
    e.stopPropagation();
  }, {passive:false});
  settingsClose.addEventListener("click", (e)=>{
    suppressFrameTap();
    e.preventDefault();
    e.stopPropagation();
    popFx(settingsClose);
    closeSettings();
  });

  settingsModal.addEventListener("click", (e)=>{ if (e.target === settingsModal) closeSettings(); });
  settingsModal.querySelector(".sheet").addEventListener("click", (e)=>e.stopPropagation());

  function flipArabic(){
    showArabic = !showArabic;
    setToggleUI();
    refreshCurrentTextAndFit();
    if (!paused && audio.getAttribute("src")) audio.play().catch(()=>{});
  }
  function flipBg(){
    showBackground = !showBackground;
    setToggleUI();
    if (!paused && audio.getAttribute("src")) audio.play().catch(()=>{});
  }
  function flipAuto(){
    autoplay = !autoplay;
    setToggleUI();
    if (autoplay){
      updateMediaSession();
      if (!paused && audio.getAttribute("src")){
        audio.play().then(()=>{ tapToUnmute.style.display="none"; }).catch(()=>{});
      }
    }
  }

  function bindToggle(btn, action){
    btn.addEventListener("pointerdown", (e)=>{
      e.preventDefault();
      e.stopPropagation();
      popFx(btn);
      action();
    }, {passive:false});
    btn.addEventListener("click", (e)=>{ e.preventDefault(); e.stopPropagation(); });
  }

  bindToggle(swArabicBtn, flipArabic);
  bindToggle(swBgBtn, flipBg);
  bindToggle(swAutoBtn, flipAuto);
  bindToggle(swFSBtn, async ()=>{
    await toggleFullscreen(!isFullscreen());
    setToggleUI();
  });

  // --------- SIMPLE WIZARD (2 steps) ----------
  function computeWizVerseMeta(parsed){
    if (!parsed) { wizVerseSet = new Set(); wizVerseMax = 0; return; }
    wizVerseSet = parsed.verseSet || new Set();
    wizVerseMax = parsed.verseMax || 0;
    if (!wizVerseMax && wizVerseSet.size){
      wizVerseMax = Math.max(...Array.from(wizVerseSet));
    }
  }

  function renderWizardSurahList(){
    const q = fmt(wizSurahSearch.value).toLowerCase();
    const items = surahs.filter(s =>
      fmt(s.title).toLowerCase().includes(q) ||
      fmt(s.file).toLowerCase().includes(q)
    );

    wizSurahList.innerHTML = "";
    for (const s of items){
      const row = document.createElement("div");
      row.className = "wizItem" + (s.file === wizSelectedFile ? " active" : "");
      row.textContent = s.title ? s.title : s.file;
      row.addEventListener("click", async ()=>{
        popFx(row);
        wizSelectedFile = s.file;
        try{
          wizParsed = await loadSurahParsed(s);
          computeWizVerseMeta(wizParsed);
          renderWizardSurahList();
        }catch(err){
          console.error(err);
        }
      });
      wizSurahList.appendChild(row);
    }
    if (!items.length){
      const empty = document.createElement("div");
      empty.style.opacity = ".75";
      empty.style.textAlign = "center";
      empty.style.padding = "10px";
      empty.textContent = "No matches";
      wizSurahList.appendChild(empty);
    }
  }

  function renderWizardVerseList(){
    const raw = fmt(wizVerseSearch.value);
    const q = raw.replace(/[^\d]/g, "");
    let verses = [];

    const max = Number(wizVerseMax || 0);
    if (max > 0){
      for (let i=1; i<=max; i++) verses.push(i);
    } else if (wizVerseSet && wizVerseSet.size){
      verses = Array.from(wizVerseSet).sort((a,b)=>a-b);
    } else {
      verses = [1,2,3];
    }

    if (q){
      const n = Number(q);
      if (Number.isFinite(n)) verses = verses.filter(v => String(v).startsWith(String(n)));
    }

    wizVerseList.innerHTML = "";
    for (const v of verses.slice(0, 60)){
      const row = document.createElement("div");
      row.className = "wizVerseItem" + (v === wizSelectedVerse ? " active" : "");
      row.textContent = v + ".";
      row.addEventListener("click", ()=>{
        popFx(row);
        wizSelectedVerse = v;
        renderWizardVerseList();
      });
      wizVerseList.appendChild(row);
    }
  }

  function setWizardStep(step){
    wizStep1.classList.toggle("active", step === 1);
    wizStep2.classList.toggle("active", step === 2);
  }

  // ---- KEYBOARD RULE: inputs stay readonly until user taps search row ----
  function armInputForTap(inputEl, rowEl){
    const enableAndFocus = ()=>{
      if (!inputEl) return;
      inputEl.readOnly = false;
      try{ inputEl.focus({preventScroll:true}); }catch(_){ inputEl.focus(); }
    };
    const disable = ()=>{
      if (!inputEl) return;
      inputEl.readOnly = true;
      try{ inputEl.blur(); }catch(_){}
    };

    // keep readonly by default
    inputEl.readOnly = true;

    // only open keyboard when row is clicked/tapped
    rowEl.addEventListener("pointerdown", (e)=>{
      e.preventDefault();
      e.stopPropagation();
      suppressFrameTap();
      popFx(rowEl);
      enableAndFocus();
    }, {passive:false});

    // also allow direct tap on input itself
    inputEl.addEventListener("pointerdown", (e)=>{
      e.preventDefault();
      e.stopPropagation();
      suppressFrameTap();
      enableAndFocus();
    }, {passive:false});

    // once user leaves, lock again so keyboard won't pop next time automatically
    inputEl.addEventListener("blur", ()=>{ disable(); }, {passive:true});
  }
  armInputForTap(wizSurahSearch, surahSearchRow);
  armInputForTap(wizVerseSearch, verseSearchRow);

  function openWizard(forceFresh){
    suppressFrameTap();
    ensureUserGesture();

    // lock search inputs (prevents auto keyboard on open)
    wizSurahSearch.readOnly = true;
    wizVerseSearch.readOnly = true;
    wizSurahSearch.value = "";
    wizVerseSearch.value = "";

    // pause media (optional)
    if (current && !ended) setPaused(true);

    wizard.style.display = "block";
    wizard.setAttribute("aria-hidden","false");
    popFx(navCircle);

    setWizardStep(1);

    if (forceFresh || !surahs.length){
      loadSurahs().then(()=>{
        if (current?.file){
          wizSelectedFile = current.file;
          wizParsed = current;
          computeWizVerseMeta(wizParsed);
          wizSelectedVerse = Number(current.segments?.[idx]?.ayah ?? 1) || 1;
        } else {
          wizSelectedFile = "";
          wizParsed = null;
          wizSelectedVerse = 1;
        }
        renderWizardSurahList();
        wizNext.disabled = !wizSelectedFile;
      });
    } else {
      if (current?.file){
        wizSelectedFile = current.file;
        wizParsed = current;
        computeWizVerseMeta(wizParsed);
        wizSelectedVerse = Number(current.segments?.[idx]?.ayah ?? 1) || 1;
      } else {
        wizSelectedFile = "";
        wizParsed = null;
        wizSelectedVerse = 1;
      }
      renderWizardSurahList();
      wizNext.disabled = !wizSelectedFile;
    }
  }

  function closeWizard(){
    wizard.style.display = "none";
    wizard.setAttribute("aria-hidden","true");
    wizSurahSearch.readOnly = true;
    wizVerseSearch.readOnly = true;
    if (current && !ended) setPaused(false);
  }

  wizSurahSearch.addEventListener("input", ()=>{ renderWizardSurahList(); });
  wizVerseSearch.addEventListener("input", ()=> renderWizardVerseList());

  // enable next when selected
  const observeSelection = new MutationObserver(()=>{ wizNext.disabled = !wizSelectedFile; });
  observeSelection.observe(wizSurahList, { childList:true, subtree:true });

  wizNext.addEventListener("click", ()=>{
    suppressFrameTap();
    popFx(wizNext);
    if (!wizSelectedFile || !wizParsed) return;
    setWizardStep(2);
    wizVerseSearch.value = "";
    renderWizardVerseList();
  });

  wizBack.addEventListener("click", ()=>{
    suppressFrameTap();
    popFx(wizBack);
    setWizardStep(1);
  });

  wizPlay.addEventListener("click", async ()=>{
    suppressFrameTap();
    popFx(wizPlay);
    ensureUserGesture();

    if (!wizSelectedFile) return;
    const entry = surahs.find(s => s.file === wizSelectedFile) || (wizParsed ? wizParsed.entry : null);
    if (!entry) return;

    const v = Number(wizSelectedVerse || 1) || 1;

    closeWizard();
    await openSurah(entry, { startAyah: v });

    setPaused(false);
    if (audio.getAttribute("src")){
      audio.play().then(()=> tapToUnmute.style.display="none").catch(()=> tapToUnmute.style.display="grid");
    }
  });

  wizard.addEventListener("click", (e)=>{ if (e.target === wizard) closeWizard(); });

  // Verse circle opens wizard
  navCircle.addEventListener("pointerdown", (e)=>{ suppressFrameTap(); e.preventDefault(); e.stopPropagation(); }, {passive:false});
  navCircle.addEventListener("click", (e)=>{
    e.preventDefault();
    e.stopPropagation();
    glowCircle();
    openWizard(false);
  });

  // ---------- DEMO ----------
  function allDimTargets(){ return Array.from(frame.querySelectorAll(".dimTarget")); }
  function clearNoDim(){ allDimTargets().forEach(n => n.classList.remove("noDim")); }

  function ensureVisibleDuringDemo(targetEl){
    if (!targetEl) return;
    const host = targetEl.closest(".dimTarget");
    if (host) host.classList.add("noDim");
    if (targetEl.classList.contains("dimTarget")) targetEl.classList.add("noDim");
  }

  function clearHighlights(){
    btnGear.classList.remove("hl");
    btnHelp.classList.remove("hl");
    navCircle.classList.remove("hlGold");
    infoOrb.classList.remove("hl");
    clearNoDim();
  }

  function startDemo(force){
    if (!force && demo.style.display === "block") return;

    demoIndex = 0;
    frame.classList.add("demoActive");
    clearNoDim();

    if (current){
      stopTimers();
      try{ audio.pause(); }catch(_){}
      try{ bg.pause(); }catch(_){}
      paused = true;
      syncPauseUI();
    }

    demo.style.display = "block";
    demo.setAttribute("aria-hidden","false");
    renderDemoStep();
  }

  function resumeAfterDemo(){
    clearHighlights();
    frame.classList.remove("demoActive");

    demo.style.display = "none";
    demo.setAttribute("aria-hidden","true");

    if (!current || ended) return;

    paused = false;
    syncPauseUI();
    const seg = current?.segments?.[idx];
    if (!seg) return;

    if (showBackground) bg.play().catch(()=>{});
    if (audio.getAttribute("src")){
      audio.play().then(()=> tapToUnmute.style.display="none")
        .catch(()=> tapToUnmute.style.display="grid");
    }
    startProgressLoop(seg);
  }

  function renderDemoStep(){
    clearHighlights();

    const steps = [
      { text: "Swipe up/down to move between verses.", mini: true,  highlight: null },
      { text: "Use ‚öôÔ∏è Settings to toggle Arabic, background, autoplay, fullscreen. Tap ‚ùî to see this demo again.", mini: false, highlight: "gear" },
      { text: "Tap the VERSE button to pick a surah + verse, then press Play.", mini: false, highlight: "nav" },
      { text: "If extra info exists for a verse, tap the info button i.", mini: false, highlight: "info" }
    ];

    const s = steps[demoIndex];
    demoStep.textContent = `${demoIndex + 1} / ${steps.length}`;
    demoText.textContent = s.text;
    demoMini.style.display = s.mini ? "flex" : "none";

    ensureVisibleDuringDemo(demo);

    if (s.highlight === "gear"){
      btnGear.classList.add("hl");
      btnHelp.classList.add("hl");
      ensureVisibleDuringDemo(btnGear);
      ensureVisibleDuringDemo(btnHelp);
      ensureVisibleDuringDemo(overlayTop);
    }
    if (s.highlight === "nav"){
      navCircle.classList.add("hlGold");
      ensureVisibleDuringDemo(navCircle);
      ensureVisibleDuringDemo(el("badge"));
    }
    if (s.highlight === "info"){
      if (infoOrb.style.display !== "none") {
        infoOrb.classList.add("hl");
        ensureVisibleDuringDemo(infoOrb);
        ensureVisibleDuringDemo(el("badge"));
      } else {
        navCircle.classList.add("hlGold");
        ensureVisibleDuringDemo(navCircle);
        ensureVisibleDuringDemo(el("badge"));
      }
    }

    demoNext.textContent = (demoIndex === steps.length - 1) ? "Done" : "Next";
  }

  demoNext.addEventListener("click", (e)=>{
    suppressFrameTap();
    e.preventDefault(); e.stopPropagation();
    popFx(demoNext);

    const last = (demoIndex >= 3);
    if (last){
      resumeAfterDemo();
      return;
    }
    demoIndex++;
    renderDemoStep();
  });

  btnHelp.addEventListener("pointerdown", (e)=>{ suppressFrameTap(); e.preventDefault(); e.stopPropagation(); }, {passive:false});
  btnHelp.addEventListener("click", (e)=>{
    suppressFrameTap();
    e.preventDefault(); e.stopPropagation();
    popFx(btnHelp);
    startDemo(true);
  });

  // Button pointerdown suppression
  btnGear.addEventListener("pointerdown", (e)=>{ suppressFrameTap(); e.preventDefault(); e.stopPropagation(); }, {passive:false});
  btnHelp.addEventListener("pointerdown", (e)=>{ suppressFrameTap(); e.preventDefault(); e.stopPropagation(); }, {passive:false});
  infoOrb.addEventListener("pointerdown", (e)=>{ suppressFrameTap(); e.preventDefault(); e.stopPropagation(); }, {passive:false});

  // Optional: open wizard on first load
  function boot(){
    updateUIScale();
    setToggleUI();
    stopPlayback();
    openWizard(true);
  }
  boot();
</script>
</body>
</html>
